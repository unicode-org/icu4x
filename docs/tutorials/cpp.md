# Using ICU4X from C++

ICU4X's core functionality is completely available from C++, with headers generated by [Diplomat].

Generated headers can be found under [`ffi/diplomat/cpp/include`], with Sphinx docs at [`ffi/diplomat/cpp/docs`]. The port is header-only; no additional C++ translation units need to be compiled to use ICU4X from C++.

Typically C++ users can build ICU4X by building a thin Rust wrapper around the `icu_capi` crate, and link the resultant static library to their C++ application.

Using ICU4X in C++ is best demonstrated via the [examples] present in the codebase. For example, [here's an example showing off decimal formatting in ICU4X][decimal-example-code], built with [this Makefile][decimal-example-makefile].

_We are still working on improving the user experience of using ICU4X from other languages. As such, this tutorial may be a bit sparse, but we are happy to answer questions on our [discussions forum] and help you out_

## Building and linking ICU4X

 - The `icu_capi` crate cannot be built directly; this is both because `cargo build` does not support non-local crates, and because the correct crate type (`staticlib` vs `cdylib`) can only be set in `Cargo.toml`.
    - We will define a wrapper create with all your project-specific config
        - Create a new cargo project
            - `cargo init --lib icu; cd icu`
        - Add ICU4X as a dependency 
            - `cargo add icu_capi@1.0.0`
        - Reexport ICU4X symbols
            - `echo "extern crate icu_capi;" >> src/lib.rs`
        - Specify features with `cargo add icu_capi@1.0.0 --features ...`:
            - `buffer_provider` for working with blob data providers (`ICU4XDataProvider::create_from_byte_slice()`)
            - `provider_test` to include testing data (`ICU4XDataProvider::create_test()`)
            - `provider_fs` for loading data from the file system (`ICU4XDataProvider::create_fs()`). This also requires enabling a syntax on the `icu_provider` crate: `cargo add icu_provider --features deserialize_{json,postcard_1,bincode_1}`
            - `logging` and `simple_logger` enable basic stdout logging of error metadata. Further loggers can be added on request.
            - `cpp_default` turns on a bunch of these and is useful for exploration, but should not be used in production as it enables `provider_test`
        - Set the desired crate type
            - Insert `crate-type = ["staticlib"]` in `Cargo.toml`'s `[lib]` section
            - You can also use `cdylib` to build a dynamic library
        - *Optional*: configure additional build options
            - Under `Cargo.toml`'s `[profile.release]` key, you can set options like `lto = true`, `opt-level = "s"`, etc.
            - See [cargo profiles](cargo-profiles) for more options
    - You can now use `cargo build --release` to build the library
        - The output will be in ``
    - Copy the library to the desired location
        - Its location is `icu/target/release/libicu.a`
        - When building a dynamic library, it will use a system-specific file extension (`.so`, `.dylib`, etc.) 
- Copy the header files from the `icu_capi` crate's source
    - Their location is `~/.cargo/registry/src/*/icu_capi-1.0.0/cpp/include`
        - The `*` in this path is some fingerprint, your shell will expand it when using e.g. `cp`
    - Make sure to use the same version as above
- Compile with `g++ -std=c++17 libicu.a -ldl -lpthread -lm`. C++ versions beyond C++17 are supported, as are other C++ compilers.

## Using ICU4X from C++
Here's an annotated, shorter version of the fixed decimal example, that can be built using the steps above, using `--features cpp_default`:

 ```cpp
#include "path/to/include/ICU4XFixedDecimalFormatter.hpp"
#include "path/to/include/ICU4XDataStruct.hpp"
#include "path/to/include/ICU4XLogger.hpp"

#include <iostream>
#include <array>

int main() {
    // For basic logging
    ICU4XLogger::init_simple_logger();

    // Create a locale object representing Bangla
    ICU4XLocale locale = ICU4XLocale::create_from_string("bn").ok().value();

    // Use a testing data provider
    // Production code probably should use create_fs() or create_from_byte_slice()
    // with data generated by icu4x-datagen
    ICU4XDataProvider dp = ICU4XDataProvider::create_test();

    // Create a formatter object with the appropriate settings
    ICU4XFixedDecimalFormatter fdf = ICU4XFixedDecimalFormatter::create_with_grouping_strategy(
        dp, locale, ICU4XFixedDecimalGroupingStrategy::Auto).ok().value();

    // Create a decimal representing the number 1,000,007
    ICU4XFixedDecimal decimal = ICU4XFixedDecimal::create_from_u64(1000007);

    // Format it to a string
    std::string out = fdf.format(decimal).ok().value();

    // Report formatted value
    std::cout << "Formatted value is " << out << std::endl;
    if (out != "১০,০০,০০৭") {
        std::cout << "Output does not match expected output" << std::endl;
        return 1;
    }
    return 0;
}
```

## Embedded platforms (`no_std`)

Users wishing to use ICU4X on a `no_std` platform will need to add an allocator and panic hooks the wrapper crate. For example using the `dlmalloc` allocator:

`lib.rs:`

```rust
#![feature(alloc_error_handler)]

#![no_std]

extern crate icu_capi;
extern crate dlmalloc;

use core::alloc::Layout;
use core::panic::PanicInfo;
use dlmalloc::GlobalDlmalloc;

#[global_allocator]
static ALLOCATOR: GlobalDlmalloc = GlobalDlmalloc;

#[alloc_error_handler]
fn alloc_error(_layout: Layout) -> ! {
    loop {}
}

#[panic_handler]
fn panic(_info: &PanicInfo) -> ! {
    loop {}
}
```

This can then be compiled with `cargo +nightly -Z build-std=std,panic_abort -Z build-std-features=panic_immediate_abort` for a minimal build.

## Tips

Documentation can be found in the Sphinx docs found [`ffi/diplomat/cpp/docs`]. These docs mirror the Rust code in the `icu_capi` crate, which can be explored on [docs.rs][rust-docs], though the precise types used may be different.

Fallible methods return `diplomat::result`, a Result type that can most commonly be converted to a `std::optional` over its Ok/Err types by calling `.ok()` or `.err()`. Most methods either use `ICU4XError` (an enum of error codes) as their error type, or `std::monostate`. Further error details can be logged by enabling a logger via `ICU4XLogger`, further loggers may be added on request.

The C++ headers include C headers for the underlying APIs as well, under namespace `capi`, found in the `.h` files. While these can be used directly, we recommend against it unless you are writing C code. These headers are not intended to be ergonomic and primarily exist for the C++ headers to use internally.

Slices are represented using `std::span` if available, otherwise a simple wrapper called `diplomat::span` is used.

These bindings may be customized by running `diplomat-tool` directly (including replacing the types used with alternate types like `mozilla::Span`), please ask on our [discussions forum] for more help on this.


 [discussions forum]: https://github.com/unicode-org/icu4x/discussions
 [Diplomat]: https://github.com/rust-diplomat/diplomat
 [staticlib-crates]: https://crates.io/crates/icu_capi_staticlib
 [staticlib-source]: https://github.com/unicode-org/icu4x/tree/main/ffi/capi_staticlib
 [freertos port]: https://github.com/unicode-org/icu4x/blob/main/ffi/freertos/src/lib.rs
 [examples]: https://github.com/unicode-org/icu4x/blob/main/ffi/diplomat/cpp/examples/
 [decimal-example-code]: https://github.com/unicode-org/icu4x/blob/main/ffi/diplomat/cpp/examples/fixeddecimal/test.cpp
 [decimal-example-makefile]: https://github.com/unicode-org/icu4x/blob/main/ffi/diplomat/cpp/examples/fixeddecimal/Makefile
 [`ffi/diplomat/cpp/include`]: https://github.com/unicode-org/icu4x/tree/main/ffi/diplomat/cpp/include
 [`ffi/diplomat/cpp/docs`]: https://github.com/unicode-org/icu4x/tree/main/ffi/diplomat/cpp/docs
 [rust-docs]: https://docs.rs/icu_capi/latest/icu_capi/
 [cargo-profiles]: https://doc.rust-lang.org/cargo/reference/profiles.html
