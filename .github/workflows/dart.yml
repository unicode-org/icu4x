# This file is part of ICU4X. For terms of use, please see the file
# called LICENSE at the top level of the ICU4X source tree
# (online at: https://github.com/unicode-org/icu4x/blob/main/LICENSE ).

name: package:icu4x
permissions:
  pull-requests: read # Changed to read, as we are only reading labels
  contents: read # Added for checkout action

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - ".github/workflows/dart.yml"
      - "ffi/dart/**"
      - "ffi/capi/bindings/dart/**"
  push:
    branches: [main]
    paths:
      - ".github/workflows/dart.yml"
      - "ffi/dart/**"
      - "ffi/capi/bindings/dart/**"
  schedule:
    - cron: "0 0 * * 0" # weekly

jobs:
  # This job will determine if the 'skip-fetch' tag is present
  check_skip_fetch:
    runs-on: ubuntu-latest
    outputs:
      skip_fetch: ${{ steps.get-labels.outputs.skip_fetch }}
    permissions:
      pull-requests: read
    if: github.event_name == 'pull_request'
    steps:
      - name: Get PR Labels
        id: get-labels
        run: |
          labels="$(gh api repos/$OWNER/$REPO_NAME/pulls/$PULL_REQUEST_NUMBER --jq '.labels.[].name')"
          echo "Found labels: $labels"
          if echo "$labels" | grep -q "skip-fetch"; then
            echo "skip_fetch=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_fetch=false" >> "$GITHUB_OUTPUT"
          fi
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
