name: Webpack Build

on:
  push:
    branches-ignore: ["main"]

jobs:
  credentials:
    name: "Check Credentials"
    runs-on: "ubuntu-latest"
    env:
      ICU4X_GCP_SA_KEY: "${{ secrets.ICU4X_GCP_SA_KEY }}"
    steps:
    - name: "Check for credentials"
      run: |
        if [ -z "$ICU4X_GCP_SA_KEY" ]
        then
          echo "GCP key not found. Webpack artifacts will not be uploaded. If you are a frequent contributor, you may add the key to your fork; for instructions, see 'artifacts-build.yml'"
          exit 1;
        fi
  webpack:
    name: Run Webpack, authenticate to GCS, and upload artifacts
    needs: credentials
    runs-on: "ubuntu-latest"
    env:
      GCP_PROJECT_ID: "dev-infra-273822"
      GCP_BUCKET_ID: "icu4x-pr-artifacts"
    steps:
    - uses: actions/checkout@v2
    - name: Load the default Rust toolchain via the rust-toolchain file.
      run: rustup show
    - name: Authenticate to Google Cloud
      uses: google-github-actions/setup-gcloud@v0.2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.ICU4X_GCP_SA_KEY }}
        export_default_credentials: true
    - name: Run Webpack
      uses: actions-rs/cargo@v1
      with:
        command: make
        args: diplomat-build-webpack-demo
    - name: Upload Webpack bundle to Google Cloud Storage
      run: |
        gsutil -m cp -r ffi/diplomat/wasm/demo-app/dist/ gs://${{ env.GCP_BUCKET_ID }}/gha/${{ github.sha }}/wasm-demo
    # - name: "‚≠ê‚≠ê‚≠ê Links to Uploaded Artifacts ‚≠ê‚≠ê‚≠ê"
    #   run: |
    #     echo "::group::üìñ Docs Preview"
    #     echo "http://${{ env.GCP_BUCKET_ID }}.storage.googleapis.com/gha/${{ github.sha }}/docs/icu/index.html"
    #     echo "::endgroup::"

