name: Webpack Build

on:
  push:
    branches-ignore: ["main"]

jobs:
  credentials:
    name: Check Credentials
    runs-on: "ubuntu-latest"
    env:
      ICU4X_GCP_SA_KEY: "${{ secrets.ICU4X_GCP_SA_KEY }}"
    steps:
    - name: "Check for credentials"
      run: |
        if [ -z "$ICU4X_GCP_SA_KEY" ]
        then
          echo "GCP key not found. Webpack artifacts will not be uploaded. If you are a frequent contributor, you may add the key to your fork; for instructions, see 'artifacts-build.yml'"
          exit 1;
        fi

  webpack:
    name: Build
    needs: credentials
    runs-on: "ubuntu-latest"
    env:
      GCP_PROJECT_ID: "dev-infra-273822"
      GCP_BUCKET_ID: "icu4x-pr-artifacts"
    steps:
    - uses: actions/checkout@v2

    - name: Load the default Rust toolchain via the rust-toolchain file.
      run: rustup show

    - name: Install prerequisites for wasm build
      run: |
        rustup toolchain list
        rustup toolchain install nightly-2022-04-05
        rustup component add --toolchain nightly-2022-04-05 rust-src

    - name: Authenticate to Google Cloud
      uses: google-github-actions/setup-gcloud@v0.2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.ICU4X_GCP_SA_KEY }}
        export_default_credentials: true

    - name: Get cargo-make version
      id: cargo-make-version
      run: |
        echo "::set-output name=hash::$(cargo search cargo-make | grep '^cargo-make =' | md5sum)"
      shell: bash

    - name: Attempt to load cached cargo-make
      uses: actions/cache@v2
      id: cargo-make-cache
      with:
        path: |
          ~/.cargo/bin/cargo-make
          ~/.cargo/bin/cargo-make.exe
        key: ${{ runner.os }}-make-${{ steps.cargo-make-version.outputs.hash }}

    - name: Install cargo-make
      if: steps.cargo-make-cache.outputs.cache-hit != 'true'
      uses: actions-rs/install@v0.1.2
      with:
        crate: cargo-make
        version: latest

    - name: Run Webpack
      uses: actions-rs/cargo@v1
      with:
        command: make
        args: diplomat-build-webpack-demo

    - name: Upload Webpack bundle to Google Cloud Storage
      run: |
        # gsutil cors set ffi/diplomat/wasm/cors-config-file.json gs://${{ env.GCP_BUCKET_ID }}
        gsutil -m cp -r ffi/diplomat/wasm/wasm-demo/dist/ gs://${{ env.GCP_BUCKET_ID }}/gha/${{ github.sha }}/wasm-demo

    - name: Checkout gh-pages
      uses: actions/checkout@v2
      with:
        repository: QnnOkabayashi/icu4x
        ref: gh-pages

    - name: Copy index.html from main
      run: |
        rm -rf wasm-demo
        mkdir wasm-demo
        printf "const gcs=document.createElement('script');gcs.setAttribute('src','https://storage.googleapis.com/icu4x-pr-artifacts/gha/%s/wasm-demo/bundle.js');document.body.appendChild(gcs);" ${{ github.sha }} > wasm-demo/index.js
        git checkout ${GITHUB_REF##*/} -- ffi/diplomat/wasm/wasm-demo/index.html > wasm-demo/index.html
        git diff-index --quiet HEAD ||  git commit -m "Deploy with new hash"
        git push


