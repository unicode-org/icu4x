# This file is part of ICU4X. For terms of use, please see the file
# called LICENSE at the top level of the ICU4X source tree
# (online at: https://github.com/unicode-org/icu4x/blob/main/LICENSE ).

# This is a cargo-make file included in the toplevel Makefile.toml

[tasks.test-ffi]
description = "Run FFI tests"
category = "ICU4X Development"
dependencies = [
    "cargo-make-min-version",
    "test-c",
    "test-c-tiny",
    "test-cpp",
    "test-js",
    "build-wearos-ffi",
    "test-nostd",
]

[tasks.verify-ffi]
description = "Run FFI tests that verify checked in code is up to date"
category = "ICU4X Development"
dependencies = [
    "cargo-make-min-version",
    "verify-diplomat-gen",
    "verify-diplomat-coverage",
    "verify-gn-gen",
]

# Some tasks need a minimum version of cargo-make. Configs within cargo-make
# task stanzas such as this allow setting the minimum version of deps (including
# min version for cargo-make itself). But cargo-make might only be applying
# such dep upgrades defined in the `install_crate` field after the task script
# has run.
[tasks.cargo-make-min-version]
description = "Verify that the minimum version of cargo-make exists"
category = "ICU4X Development"
install_crate = { crate_name = "cargo-make", binary = "cargo", test_arg = ["make", "--version"], min_version = "0.36.2" }

[tasks.diplomat-coverage]
description = "Produces the list of ICU APIs that are not exported through Diplomat"
category = "ICU4X Development"
toolchain = "nightly-2022-08-25"
script = '''
cargo run -p icu_ffi_coverage --all-features > ffi/diplomat/ffi_coverage/tests/missing_apis.txt
'''

[tasks.verify-diplomat-coverage]
description = "Verify that checked-in Diplomat coverage is up to date"
category = "ICU4X Development"
dependencies = [
    "diplomat-coverage",
]
script_runner = "@duckscript"
script = '''
exit_on_error true
code = exec --get-exit-code git diff --exit-code -- ffi/diplomat/ffi_coverage/tests
if ${code}
    trigger_error "Diplomat coverage dump need to be regenerated. Please run `cargo make diplomat-coverage` and commit."
end
'''

[tasks.verify-diplomat-gen]
description = "Verify that checked-in Diplomat bindings are up to date"
category = "ICU4X Development"
dependencies = [
    "diplomat-gen",
]
script_runner = "@duckscript"
script = '''
exit_on_error true
code = exec --get-exit-code git diff --exit-code -- ffi/diplomat
if ${code}
    trigger_error "Diplomat bindings need to be regenerated. Please run `cargo make diplomat-install`, then `cargo make diplomat-gen`, and commit. (Testing against different Diplomat versions may omit install step.)"
end
'''

[tasks.diplomat-gen]
description = "Regenerate Diplomat bindings"
category = "ICU4X Development"
dependencies = [
    "diplomat-gen-c",
    "diplomat-gen-cpp",
    "diplomat-gen-js",
]

[tasks.test-c]
description = "Run C API tests"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat/c/examples/pluralrules
rm -f ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../fixeddecimal
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../locale
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
'''

[tasks.test-c-tiny]
description = "Run C API tests for tiny targets"
category = "ICU4X Development"
install_crate = { rustup_component_name = "rust-src" }
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat/c/examples/fixeddecimal_tiny
rm -f ../../../../../target/debug/libicu_capi_staticlib.a
rm -f ../../../../../target/x86_64-unknown-linux-gnu/debug/libicu_capi_staticlib.a
rm -f ../../../../../target/x86_64-unknown-linux-gnu/release-opt-size/libicu_capi_staticlib.a
exec --fail-on-error make
exec ls -l
'''

[tasks.test-cpp]
description = "Run CPP tests"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat/cpp/examples/pluralrules
rm -f ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../properties
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../bidi
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../segmenter
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../datetime
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../fixeddecimal
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
cd ../fixeddecimal_wasm
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make test-host
cd ../locale
rm ../../../../../target/debug/libicu_capi_staticlib_test.a
exec --fail-on-error make
'''

[tasks.test-cpp-emscripten]
description = "Run the C++-emscripten test (needs emsdk)"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat/cpp/examples/fixeddecimal_wasm
exec make test
'''

[tasks.test-js]
description = "Run JS tests"
category = "ICU4X Development"
script_runner = "@duckscript"
# Note: --foreground-scripts makes npm forward the output of build.sh
script = '''
cd ffi/diplomat/js/examples/node
exec --fail-on-error npm ci --foreground-scripts
exec --fail-on-error npm test
'''

[tasks.test-cppdoc]
description = "Build the cpp tests"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat/cpp/docs;
exec --fail-on-error make html
'''

[tasks.diplomat-gen-c]
description = "Generate C headers for the FFI with Diplomat"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat
# Duckscript doesn't support globs in rm, so we delete the dir
rm -r ./c/include/
mkdir ./c/include
exec --fail-on-error diplomat-tool c ./c/include
'''

[tasks.diplomat-gen-cpp]
description = "Generate C++ headers for the FFI with Diplomat"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/diplomat


# Duckscript doesn't support globs in rm, so we delete the dir.
# Preserve conf.py across the deletion.
conf_py = readfile ./cpp/docs/source/conf.py
rm -r ./cpp/include
mkdir ./cpp/include
rm -r ./cpp/docs/source
mkdir ./cpp/docs/source
writefile ./cpp/docs/source/conf.py ${conf_py}
exec --fail-on-error diplomat-tool cpp ./cpp/include --docs ./cpp/docs/source --docs-base-urls=*:https://unicode-org.github.io/icu4x-docs/doc/ 
'''

[tasks.diplomat-gen-js]
description = "Generate JS bindings for the FFI with Diplomat"
category = "ICU4X Development"
script_runner = "bash"
script = '''
set -e
cd ffi/diplomat

# Duckscript doesn't support globs in rm, so we delete the dir.
# Preserve conf.py across the deletion.
conf_py=$(<./js/docs/source/conf.py)
rm -r ./js/include
mkdir ./js/include
rm -r ./js/docs/source
mkdir ./js/docs/source
echo "$conf_py" > ./js/docs/source/conf.py

diplomat-tool js ./js/include/ --docs ./js/docs/source --docs-base-urls=*:https://unicode-org.github.io/icu4x-docs/doc/

# TODO: Fix diplomat bug
find ./js/docs/source -type f -exec sed -i  {} -e 's/staticfunction/function/g' \;
'''

[tasks.build-wearos-ffi]
description = "Build ICU4X CAPI for Cortex"
category = "ICU4X FFI"
toolchain = "${ICU4X_NIGHTLY_TOOLCHAIN}"
install_crate = { rustup_component_name = "rust-src" }
env = { "RUSTFLAGS" = "-Ctarget-cpu=cortex-m33 -Cpanic=abort" }
command = "cargo"
args = ["build", "--package", "icu_freertos",
        "--target", "thumbv8m.main-none-eabihf",
        "--no-default-features", "--features=wearos",
        "--profile=release-opt-size",
        "-Zbuild-std", "-Zbuild-std=std,panic_abort", "-Zbuild-std-features=panic_immediate_abort"]

[tasks.test-nostd]
description = "Ensure ICU4X core builds on no-std"
category = "ICU4X FFI"
toolchain = "${ICU4X_NIGHTLY_TOOLCHAIN}"
install_crate = { rustup_component_name = "rust-src" }
command = "cargo"
args = ["build", "--package", "icu", "--target", "thumbv7m-none-eabi"]

[tasks.diplomat-get-rev]
description = "Get current Diplomat revision"
category = "ICU4X Development"
dependencies = [ "cargo-make-min-version" ]
script_runner = "@duckscript"
script = '''
exit_on_error true
metadata = exec --fail-on-error cargo metadata
metadata = set ${metadata.stdout}
# Parse output
metadata = json_parse --collection ${metadata}
# packages = metadata.packages
packages = map_get ${metadata} packages
for pkg in ${packages}
    # find pkg.name
    name = map_get ${pkg} name
    # check if it is "diplomat"
    e = eq ${name} "diplomat"
    if ${e}
        # get pkg.source
        source = map_get ${pkg} source
        version = map_get ${pkg} version
        # extract the bit between `rev=` and `#`
        handle = split ${source} "rev="
        hash_len = array_length ${handle}
        if eq ${hash_len} 2
            hash = array_get ${handle} 1
            release handle
            handle = split ${hash} "#"
            version = array_get ${handle} 0
        end
        release handle

        # print it
        echo ${version}
    end
end
release --recursive ${metadata}
'''

[tasks.diplomat-install]
description = "Install Diplomat at current Diplomat revision"
category = "ICU4X Development"
dependencies = [ "cargo-make-min-version" ]
script_runner = "@duckscript"
script = '''
exit_on_error true
rev = exec cargo make --loglevel error diplomat-get-rev
rev = trim ${rev.stdout}
if contains ${rev} "."
    echo "Installing Diplomat version ${rev}"
    exec cargo install --version ${rev} diplomat-tool -f

else
    echo "Installing Diplomat rev ${rev}"
    exec cargo install --git https://github.com/rust-diplomat/diplomat.git --rev ${rev} diplomat-tool -f
end
'''

[tasks.gn-install]
description = "Install tools required for GN locally in the icu4x project"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true

mkdir ffi/gn/third_party_tools
cd ffi/gn/third_party_tools

# depot_tools contains the following things we need:
# 1. A cross-platform ninja wrapper script
# 2. cipd, a tool to download a prebuilt GN binary
if is_path_exists depot_tools
    echo "NOTE: depot_tools already exists"
else
    exec --fail-on-error git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
end

# Write an "ensure file", which is used as input to cipd
writefile ensure_file "${ICU4X_GN_PACKAGE} latest"
exec --fail-on-error depot_tools/cipd ensure -root bin -ensure-file ensure_file

# To get GNaw, we need to download Fuchsia sources
if is_path_exists fuchsia
    echo "NOTE: fuchsia already exists"
else
    exec --fail-on-error git clone --depth 1 https://fuchsia.googlesource.com/fuchsia
    exec ln -s Cargo.toml.crates-io fuchsia/tools/cargo-gnaw/Cargo.toml
end

# Install GNaw locally in the bin directory (alongside GN)
# Since the parent directory is vendored, we have no choice but to vendor here, too
mkdir .cargo
writefile .cargo/config "source = { crates-io.replace-with = 'vendored-sources', vendored-sources.directory = 'vendor' }"
exec cargo vendor --manifest-path fuchsia/tools/cargo-gnaw/Cargo.toml
exec cargo install --path fuchsia/tools/cargo-gnaw --root .

# Ensure everything works
exec --fail-on-error ./bin/gn --version
exec --fail-on-error ./bin/gnaw --help

echo "*** GN Tools Successfully Installed! Ignore all previous messages. ***"
'''

[tasks.gn-gen]
description = "Generate GN build rules for ICU4X"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true

third_party_tools = is_path_exists ffi/gn/third_party_tools
assert ${third_party_tools} "The GN third-party tools are not installed.\n*** Please run 'cargo make gn-install' ***"

cd ffi/gn
exec rm -f icu4x_root
exec ln -s ../.. icu4x_root
echo "NOTE: Created a temporary symbolic link at /ffi/gn/icu4x_root"

pwd = pwd
rm -rf vendor
output = exec --fail-on-error cargo vendor
writefile .cargo/config "# This file is part of ICU4X. For terms of use, please see the file\n"
appendfile .cargo/config "# called LICENSE at the top level of the ICU4X source tree\n"
appendfile .cargo/config "# (online at: https://github.com/unicode-org/icu4x/blob/main/LICENSE ).\n\n"
appendfile .cargo/config "# AUTO-GENERATED in ffi.toml\n"
appendfile .cargo/config ${output.stdout}
exec --fail-on-error ./third_party_tools/bin/gnaw --manifest-path "${pwd}/Cargo.toml" --project-root ${pwd} --output ${pwd}/icu4x/BUILD.gn --skip-root --gn-bin ${pwd}/third_party_tools/bin/gn

exec rm -f icu4x_root
echo "NOTE: Removed the temporary symbolic link /ffi/gn/icu4x_root"
'''

[tasks.verify-gn-gen]
description = "Verify that checked-in GN rules are up to date"
category = "ICU4X Development"
dependencies = [
    "gn-gen",
]
script_runner = "@duckscript"
script = '''
exit_on_error true
code = exec --get-exit-code git diff --exit-code -- ffi/gn
if ${code}
    trigger_error "GN rules need to be regenerated. Please run `cargo make gn-install`, then `cargo make gn-gen`, and commit."
end
'''

[tasks.gn-build]
description = "Build the GN version of ICU4X"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true

third_party_tools = is_path_exists ffi/gn/third_party_tools
assert ${third_party_tools} "The GN third-party tools are not installed.\n*** Please run 'cargo make gn-install' ***"

cd ffi/gn
exec rm -f icu4x_root
exec ln -s ../.. icu4x_root
echo "NOTE: Created temporary symbolic link at /ffi/gn/icu4x_root"

exec --fail-on-error ./third_party_tools/bin/gn gen out
exec --fail-on-error rustup run ${ICU4X_NIGHTLY_TOOLCHAIN} ./third_party_tools/depot_tools/ninja -C out

exec rm -f icu4x_root
echo "NOTE: Removed the temporary symbolic link /ffi/gn/icu4x_root"
'''

[tasks.gn-run]
description = "Run the GN version of ICU4X"
category = "ICU4X Development"
install_crate = { crate_name = "wasmer", binary = "wasmer", test_arg = ["--help"] }
dependencies = [ "gn-build" ]
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/gn
exec --fail-on-error wasmer run ./out/obj/hello_world/print_hello
'''

[tasks.gn-remove-symlink]
description = "Remove the temporary symbolic link used by GN"
category = "ICU4X Development"
script_runner = "@duckscript"
script = '''
exit_on_error true
cd ffi/gn
exec rm -f icu4x_root
'''
